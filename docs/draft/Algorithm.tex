\chapter{提案アルゴリズム}
\label{chap:algorithm}

本章では，アルゴリズムを提案する．
まず，挿入と削除に共通した部分を説明する．
その後，挿入と削除それぞれのアルゴリズムを説明する．
\textcolor{red}{前提条件}

\section{最短経路とペア依存度の変化に関する条件}
\label{sect:condition-of-variability}

ここでは，一辺が挿入または削除されたあとの最短経路およびペア依存度が変化する条件について述べる．
記号について，挿入または削除の操作後であることを明示するため，記号$'$をつける．例えば，操作後のグラフは$G'$と表す．
また，頂点$t$に対して，辺操作によって$t$への最短経路が変化する頂点の集合を$S(t)$と表す．
同様に，頂点$s$に対して，辺操作によって$s$からの最短経路が変化する頂点の集合を$T(s)$と表す．
$S(t)$および$T(s)$に属する頂点は，それぞれ$t$および$s$について，辺更新の影響を受ける頂点集合と言える．
後述するが，$S(t)$および$T(s)$具体的な式は，操作によって異なる．
さらに，頂点$s,x\in V$に対して，$T(s)$に含まれる頂点$t$についてペア依存度$\delta_{st}(x)$の総和を
$\Delta_{s\bullet}(x)$で表す\cite{Bergamini2017}．
つまり，$\Delta_{s\bullet}=\sum_{t\in T(s)}\delta_{st}(x)$である．
同様に，$\Delta'_{s\bullet}=\sum_{t\in T(s)}\delta'_{st}(x)$とする．

次の定理は，最短経路の変化が最短距離および最短経路数の変化につながることを示す．
\begin{theorem}
  \label{thm:condition-of-invariability-of-shortest-path}
  $E_{st}=E'_{st}$であることの必要十分条件は，$d_{st}=d'_{st}$かつ$\sigma_{st}=\sigma'_{st}$である．
\end{theorem}
\begin{proof}
  $E_{st}=E'_{st}$ならば$d_{st}=d'_{st}$かつ$\sigma_{st}=\sigma'_{st}$であることは自明である．

  逆は，図\ref{fig:proof-invariability-of-paths}のような$E_{st}$を，
  $d_{st}=d'_{st}$かつ$\sigma_{st}=\sigma'_{st}$を満たすように，$E_{st}\neq E'_{st}$にすることを考える．
  図において，同じ$L_i$に含まれる頂点$v$について$d_{sv}$および$d_{vt}$は一定とする．

  挿入時，長さが$L_i$間の距離より長い辺を挿入すると，$E_{st}=E'_{st}$を満たす．
  また，長さが$L_i$間の距離と等しい辺を挿入すると，$\sigma_{st}\neq\sigma'_{st}$となる．
  また，長さが$L_i$間の距離より短い辺を挿入すると$d_{st}\neq d'_{st}$となる．

  削除時，$e\notin E_{st}$である辺を削除すると，$E_{st}=E'_{st}$である．
  また，$e\in E_{st}$である辺を削除すると，$d_{st}\neq d'_{st}$または$\sigma_{st}\neq\sigma'_{st}$となる．

  したがって$d_{st}=d'_{st}$かつ$\sigma_{st}=\sigma'_{st}$を満たすように，
  $E_{st}\neq E'_{st}$とすることは不可能で，逆も成り立つ．

\end{proof}
\begin{figure}
  \centering
  \def\svgwidth{.5\columnwidth}
  \input{proof-invariability-of-paths.pdf_tex}
  \caption{$s$と$t$の一般的な最短経路}
  \label{fig:proof-invariability-of-paths}
\end{figure}

次の定理は，更新による依存度の変化量と$\Delta_{s\bullet}(x)$が一致することを示す．
\begin{theorem}
  任意の$s,x\in V$に対して，式\eqref{eq:change-amount-dependency}が成り立つ．
  \begin{equation}
    \delta'_{s\bullet}(x)-\delta_{s\bullet}(x)=\Delta'_{s\bullet}(x)-\Delta_{s\bullet}(x)
    \label{eq:change-amount-dependency}
  \end{equation}
\end{theorem}
\begin{proof}
  定理\ref{thm:condition-of-invariability-of-shortest-path}により，任意の$t\notin T(s)$に対して，
  $\sigma_{st}=\sigma'_{st}$である．さらに，$t\notin T(s)$の条件下で，任意の$x\in V$について
  $\sigma_{st}(x)=\sigma'_{st}(x)$が成り立つ．したがって，次が成り立つ．
  \begin{equation*}
    \begin{aligned}
      \delta'_{s\bullet}(x)-\delta_{s\bullet}(x)
      &=\sum_{t\neq x}\left(\frac{\sigma'_{st}(x)}{\sigma'_{st}}-\frac{\sigma_{st}(x)}{\sigma_{st}}\right) \\
      &=\sum_{t\in T(s)}\left(\frac{\sigma'_{st}(x)}{\sigma'_{st}}-\frac{\sigma_{st}(x)}{\sigma_{st}}\right)
      +\sum_{t\notin T(s)}\left(\frac{\sigma'_{st}(x)}{\sigma'_{st}}-\frac{\sigma_{st}(x)}{\sigma_{st}}\right) \\
      &=\sum_{t\in T(s)}\left(\frac{\sigma'_{st}(x)}{\sigma'_{st}}-\frac{\sigma_{st}(x)}{\sigma_{st}}\right) \\
      &=\Delta'_{s\bullet}(x)-\Delta_{s\bullet}(x)
    \end{aligned}
  \end{equation*}
\end{proof}

次の定理は，$\Delta_{s\bullet}$および$\Delta'_{s\bullet}$を効率的に計算する指針を与える．
\begin{theorem}[Bergamini et.al.\cite{Bergamini2017}]
  任意の$s\in T(v)$と$x\in V$について，次式が成り立つ．
  \begin{align}
    \Delta_{s\bullet}(x)
    &=\sum_{y|y\in\mathcal{S}_G(x)\land y\in T(s)}\frac{\sigma_{sx}}{\sigma_{sy}}(1+\Delta_{s\bullet}(y))
    +\sum_{y|y\in\mathcal{S}_G(x)\land y\notin T(s)}\frac{\sigma_{sx}}{\sigma_{sy}}\Delta_{s\bullet}(y)
    \label{label:delta-dependency-1} \\
    \Delta'_{s\bullet}(x)
    &=\sum_{y|y\in\mathcal{S}_G(x)\land y\in T(s)}\frac{\sigma'_{sx}}{\sigma'_{sy}}(1+\Delta'_{s\bullet}(y))
    +\sum_{y|y\in\mathcal{S}_G(x)\land y\notin T(s)}\frac{\sigma'_{sx}}{\sigma'_{sy}}\Delta'_{s\bullet}(y)
    \label{label:delta-dependency-2}
  \end{align}
\end{theorem}
\begin{proof}
  $t\in T(s)$とする．ただし，$t\neq x$とする．すると，$\sigma_{st}(x)/\sigma_{st}=\sum_{y\in\mathcal{S}_{G_s}(x)}\sigma_{st}(x,y)/\sigma_{st}$が成り立つ．
  \begin{equation*}
    \begin{aligned}
      \Delta_{s\bullet}(x)=\sum_{t\in T(s)}\frac{\sigma_{st}(x)}{\sigma_{st}}
      &=\sum_{t\in T(s)}\sum_{y\in\mathcal{S}_{G_s}}\frac{\sigma_{st}(x,y)}{\sigma_{st}}\\
      &=\sum_{y\in\mathcal{S}_{G_s}}\sum_{t\in T(s)}\frac{\sigma_{st}(x,y)}{\sigma_{st}}
    \end{aligned}
  \end{equation*}
  ここで，$\sigma_{sy}$個の$s-y$間の最短経路の中に，$\sigma_{sx}$個は$x$を通る．
  したがって，$t\neq x$に対して，$s-t$間の最短経路の内，$\sigma_{sx}/\sigma_{sy}\cdot\sigma_{st}(y)$個は
  $x$と$y$を通る．つまり，$\sigma_{st}(x,y)=\sigma_{sx}/\sigma_{sy}\cdot\sigma_{st}(y)$である．

  一方，$t=x$に対して，$\sigma_{st}(x,y)$は単に$\sigma_{st}$である．
  したがって，次が成り立つ．
  \begin{equation*}
    \begin{aligned}
      &\sum_{y|y\in\mathcal{S}_{G_s}(x)\land y\in T(s)}\left(\frac{\sigma_{sx}}{\sigma_{sy}}+\sum_{t\in T(s)-\{y\}}\frac{\sigma_{st}(y,x)}{\sigma_{st}}\right)
      +\sum_{y|y\in\mathcal{S}_{G_s}(x)\land y\notin T(s)}\sum_{t\in T(s)-\{y\}}\frac{\sigma_{st}(y,x)}{\sigma_{st}} \\
      &\quad=\sum_{y|y\in\mathcal{S}_{G_s}(x)\land y\in T(s)}\frac{\sigma_{sx}}{\sigma_{sy}}\left(1+\sum_{t\in T(s)-\{y\}}\frac{\sigma_{st}(y)}{\sigma_{st}}\right)
      +\sum_{y|y\in\mathcal{S}_{G_s}(x)\land y\notin T(s)}\frac{\sigma_{sx}}{\sigma_{sy}}\sum_{t\in T(s)-\{y\}}\frac{\sigma_{st}(y)}{\sigma_{st}} \\
      &\quad=\sum_{y|y\in\mathcal{S}_{G_s}(x)\land y\in T(s)}\frac{\sigma_{sx}}{\sigma_{sy}}\left(1+\Delta_{s\bullet}(y)\right)
      +\sum_{y|y\in\mathcal{S}_{G_s}(x)\land y\notin T(s)}\frac{\sigma_{sx}}{\sigma_{sy}}\Delta_{s\bullet}(y) \\
    \end{aligned}
  \end{equation*}
  $\Delta'_{s\bullet}(x)$に対しても同様に証明できる．
\end{proof}

挿入と削除共通のアルゴリズムの流れは以下である．
まず，$T(u)$および$S(v)$を計算する．
次に計算した$S(v)$および式\eqref{label:delta-dependency-1}を用いて，上書きされる最短経路の上にあるペア依存度
の分だけ媒介中心性から減算する．つまり，$B''(x):=B(x)-\sum_{s\in S(v)}\Delta_{s\bullet}(x)$とする．
次に，操作に応じたアルゴリズムによって最短距離および最短経路長を更新する．
最後に，式\eqref{label:delta-dependency-2}を用いて，新しい最短経路の上にあるペア依存度
の分だけ媒介中心性に加算する．つまり，$B'(x):=B''(x)+\sum_{s\in S(v)}\Delta'_{s\bullet}(x)$とする．

アルゴリズムの詳細を\textcolor{red}{あとで作る}に示す．

以降，挿入時と削除時それぞれに対する最短経路更新法を説明する．

\section{一辺挿入時の最短経路更新法}
\label{sect:update-apsp-on-insert}
本節では，グラフに辺が挿入されたときの最短経路更新法を提案する．
$G=(V,E)$に辺$e=\{v,w\} \not\in E$を挿入して得られるグラフを$G'=(V,E')$とする．
アルゴリズムをアルゴリズム\ref{algo:incremental-algorithm}に示す．
以下，アルゴリズムの構成について説明する．

\begin{lemma}
  \label{lemma:update-augdist-on-insert}
  $x,z\in V$に対して，$E_{xz}'\neq E_{xz}$であるための必要十分条件は
  \[ \exists y\in\mathcal{N}_{G'}(x),\,d_{xz}\geq l_{xy}+d'_{yz} \]
  である．
\end{lemma}
\begin{proof}
  \ref{lemma:condition-of-invariability-of-shortest-path}より，$E'_{xz}\neq E_{xz}$ならば
  $d'_{yx}\neq d_{yx}$または$\sigma'_{yx}\neq\sigma_{yx}$である．
  一辺が挿入されるので，すべての$s,t\in V$に対して，$d'_{st}\leq d_{st}$である．
  そのため，$\min_y(l_{xy}+d'_{yz})\leq d_{xz}$で，$\exists y,\,l_{xy}+d'_{yz}\leq d_{xz}$である．
  したがって，$E_{xz}'\neq E_{xz}$ならば$\exists y\in\mathcal{N}_{G'}(x),\,d_{xz}\geq l_{xy}+d'_{yz}$.

  逆は，逆の手順を行うことによって成り立つ.
\end{proof}

\ref{lemma:update-augdist-on-insert}を満たす$x$について，
補題\ref{lemma:distance-and-geodesics}の通りに計算する．
計算式より，$d'_{xz}$を計算するには，$d'_{xz}>d'_{yz}$であるすべての$y$について$d'_{yz}$を
計算する必要がある．したがって$d'_{xz}$の昇順に計算することとなる．
$E'_{xz}\neq E_{xz}$を満たす$x$のうち，最小の$d'_{xz}$である$x$は$x=v$である．
そのため，$v$から計算を開始し，補題\ref{lemma:update-augdist-on-insert}を満たすような
近傍を順次順位キューに追加する．

\begin{algorithm}[tbp]
  \caption{一辺挿入時のペア依存度を更新するアルゴリズム}
  \label{algo:incremental-algorithm}
  \begin{algorithmic}[1]\small
    \Procedure{Incremental}{$G,(v,w),c$}
    \State $d'_{xz}\gets d_{xz},\:\sigma'_{xz}\gets \sigma_{xz},\:\delta'_z(x)\gets \delta_z(x)\quad\forall x,z\in V(G)$
    \State $G'\gets(V(G),E(G)\cup\{(v,w)\}),\quad l_{vw}\gets c$
    \ForAll{$z\in V(G)$}
    \If{$l_{vz}>l_{wz}$}
    \State $\textsc{IncrementalPart}(G',(v,w),z)$
    \Else
    \State $\textsc{IncrementalPart}(G',(w,v),z)$
    \EndIf
    \EndFor
    \EndProcedure
  \end{algorithmic}
  \vspace{-.5cm}
  \begin{multicols}{2}
    \begin{algorithmic}[1]\small
      \makeatletter
      \setcounter{ALG@line}{11}
      \makeatother
      \Procedure{IncrementalPart}{$G',(v,w),z$}
      \If{$d_{wz}=\infty\lor d_{vz}<l_{vw}+d_{wz}$}
      \State \textbf{return}
      \EndIf
      \State \LeftComment 最短経路長および最短経路数の更新
      \State \LeftComment 第二要素をキーとする順位キュー
      \State $Q\gets((v,l_{vw}+d_{wz}))$
      \State \LeftComment $\delta_z(x)$を更新する頂点集合
      \State $S\gets\{\}$
      \While{$\lvert Q\rvert>0$}
      \State $x,\hat{d}_{xz}\gets\mathrm{popmin}(Q)$
      \State $d'_{xz}\gets\hat{d}_{xz},\:\sigma'_{xz}\gets 0$
      \ForAll{$y\in\mathcal{N}_{G'}(x)$}
      \If{$d'_{yz}\geq l_{yx}+d'_{xz}$}
      \State $\mathrm{updatekey}(Q,y,l_{yx}+d_{xz})$
      \EndIf
      \If{$d'_{xz}=l_{xy}+d'_{yz}$}
      \State $\sigma'_{xz}\gets\sigma'_{xz}+\sigma'_{yz}$
      \EndIf
      \If{$(d_{xz}=l_{xy}+d_{yz})\veebar(d'_{xz}=l_{xy}+d'_{yz})$}
      \State $S\gets S\cup\{y\}$
      \EndIf
      \EndFor
      \If{$\sigma'_{xz}\neq\sigma_{xz}$}
      \State $S\gets S\cup\{x\}$
      \EndIf
      \EndWhile
      \State \LeftComment ペア依存度の更新
      \State \LeftComment 第二要素をキーとする順位キュー
      \State $R\gets((x,d'_{xz})\vert x\in S)$
      \While{$\lvert R\rvert>0$}
      \State $x,\_\gets\mathrm{popmax}(R)$
      \State $\delta'_z(x)\gets 0$
      \If{$x=z$}
      \State \textbf{continue}
      \EndIf
      \ForAll{$y\in\mathcal{N}_G(x)$}
      \If{$d'_{yz}=l_{yx}+d'_{xz}$}
      \State $\delta'_z(x)\gets\delta'_z(x)$
      $+\frac{\sigma'_{xz}}{\sigma'_{yz}}(1+\delta'_z(y)$
      \ElsIf{$d_{zx}=l_{xy}+d_{yz}$}
      \State $\mathrm{updatekey}(R, y, d'_{yz})$
      \EndIf
      \EndFor
      \EndWhile
      \EndProcedure
    \end{algorithmic}
  \end{multicols}
\end{algorithm}

\section{一辺削除時の最短経路更新法}
\label{sect:update-apsp-on-delete}
本節では，$G=(V,E)$に辺$e=\{v,w\}\in E$を削除して得られるグラフを$G'=(V,E')$とする．
アルゴリズムをアルゴリズム\ref{algo:decremental-algorithm}に示す．
以下，アルゴリズムの構成について説明する．

\begin{lemma}
  \label{lemma:update-augdist-on-delete}
  $x,z\in V$に対して，$E_{xz}'\neq E_{xz}$であるための必要十分条件は
  \[ d_{xv}+l_{vw}+d_{wz}=d_{vz} \]
  である．
\end{lemma}
\begin{proof}
  $d_{xv}+l_{vw}+d_{wz}=d_{vz}$ならば，$x\rightarrow\cdots v\rightarrow w\rightarrow\cdots z$
  が成り立つ．このとき，次のいずれかが成り立つ．
  \begin{enumerate}
  \item $d'_{xz}>d_{xz}$
  \item $d'_{xz}=d_{xz}$または$\sigma'_{xz}<\sigma_{xz}$
  \end{enumerate}
  いずれの場合も，$d'_{xz}\neq d_{xz}$または$\sigma'_{xz}\neq\sigma_{xz}$なので，
  補題\ref{lemma:condition-of-invariability-of-shortest-path}より，$E_{xz}'\neq E_{xz}$である．

  逆は，この手順を逆に行うことで証明できる．
\end{proof}

\ref{lemma:update-augdist-on-delete}を満たす$x$について，補題\ref{lemma:distance-and-geodesics}に
示した計算式によって計算する．
挿入時と同様に，$d'_{xz}$を計算するには$d'_{xz}>d'_{yz}$であるすべての$y$について$d'_{yz}$を
計算する必要がある．したがって$d'_{xz}$の昇順に計算することとなる．
一方，挿入時と違い，$d'_{xz}$が最小となる$x$は直ちに求めることはできない．

正しい順序で$d'_{xz}$および$\sigma'_{xz}$を計算するため，次の手順で計算を行う．
\begin{enumerate}
\item 補題\ref{lemma:update-augdist-on-delete}が成り立つ頂点を，$v$を始点として探索する
\item その頂点の内，補題\ref{lemma:update-augdist-on-delete}を満たさない頂点と隣接する頂点について，
  $d'_{xz}$と$\sigma'_{xz}$を計算する
\item $d'_{xz}$と$\sigma'_{xz}$を計算した頂点を始点として，更新対象となる頂点のみを対象として，
  Dijkstra法の要領で探索を進める
\end{enumerate}

\begin{algorithm}[tbp]
  \caption{一辺削除時のペア依存度を更新するアルゴリズム}
  \label{algo:decremental-algorithm}
  \begin{algorithmic}[1]\small
    \Procedure{Decremental}{$G,(v,w),c$}
    \State $d'_{xz}\gets d_{xz},\:\sigma'_{xz}\gets \sigma_{xz},\:\delta'_z(x)\gets \delta_z(x)\quad\forall x,z\in V(G)$
    \State $G'\gets(V(G),E(G)\cup\{(v,w)\}),\quad l_{vw}\gets c$
    \ForAll{$z\in V(G)$}
    \If{$l_{vz}>l_{wz}$}
    \State $\textsc{DecrementalPart}(G',(v,w),z)$
    \Else
    \State $\textsc{DecrementalPart}(G',(w,v),z)$
    \EndIf
    \EndFor
    \EndProcedure
  \end{algorithmic}
  \begin{multicols}{2}
    \begin{algorithmic}[1]\small
      \makeatletter
      \setcounter{ALG@line}{11}
      \makeatother
      \Procedure{DecrementalPart}{$G',(v,w),z$}
      \If{$d_{wz}=\infty\lor d_{vz}<l_{vw}+d_{wz}$}
      \State \textbf{return}
      \EndIf
      \State $\mathrm{WorkSet}\gets\{v\}$
      \State $\mathrm{Affected}\gets\{v\}$
      \State
      \State \LeftComment 最短経路が変化する頂点の探索
      \While{$\lvert\mathrm{WorkSet}\rvert>0$}
      \State $x\gets\mathrm{pop}(\mathrm{WorkSet})$
      \ForAll{$y\in\mathcal{N}_{G'}(x)$}
      \If{$d_{yz}=l_{yx}+d_{xz}\land y\notin\mathrm{Affected}$}
      \State $\mathrm{Affected}\gets\mathrm{Affected}\cup\{y\}$
      \State $\mathrm{WorkSet}\gets\mathrm{WorkSet}\cup\{y\}$
      \EndIf
      \EndFor
      \EndWhile
      \State
      \State \LeftComment 最短経路長，最短経路数の更新
      \State $Q\gets()$ \Comment 第二要素をキーとする順位キュー
      \ForAll{$x\in\mathrm{Affected}$}
      \If{$\exists y\in\mathcal{N}_{G'}(x),\:y\notin\mathrm{Affected}$}
      \State $\hat{d}_{xz}\gets\min(\{l_{xy}+d_{yz}\vert y\in\mathcal{N}_{G'}(x),y\notin\mathrm{Affected}\})$
      \Else
      \State $\hat{d}_{xz}\gets\infty$
      \EndIf
      \If{$\hat{d}_{xz}=\infty$}
      \State $d'_{xz}\gets\infty,\quad\sigma'_{xz}\gets 0$
      \Else
      \State $\mathrm{updatekey}(Q, x, \hat{d}_{xz})$
      \EndIf
      \EndFor
      \State
      \State $S\gets\{w\}$ \Comment $\delta_z(x)$を更新する頂点集合
      \While{$\lvert Q\rvert>0$}
      \State $x,\hat{d}_{xz}\gets\mathrm{popmin}(Q)$
      \State $\mathrm{Affected}\gets\mathrm{Affected}\setminus\{x\}$
      \State $d'_{xz}\gets\hat{d}_{xz},\quad\sigma'_{xz}\gets 0$
      \ForAll{$y\in\mathrm{Affected}$}
      \If{$d'_{yz}\geq l_{yx}+d'_{xz}$}
      \State $\mathrm{updatekey}(Q,y,l_{yx}+d_{xz})$
      \EndIf
      \If{$d'_{xz}=l_{xy}+d'_{yz}$}
      \State $\sigma'_{xz}\gets\sigma'_{xz}+\sigma'_{yz}$
      \EndIf
      \If{$d_{xz}=l_{xy}+d_{yz}\veebar d'_{xz}=l_{xy}+d'_{yz}$}
      \State $S\gets S\cup\{y\}$
      \EndIf
      \If{$d_{yz}=l_{yx}+d_{xz}\veebar d'_{yz}=l_{yx}+d'_{xz}$}
      \State $S\gets S\cup\{x\}$
      \EndIf
      \EndFor
      \If{$\sigma'_{xz}\neq\sigma_{xz}$}
      \State $S\gets S\cup\{x\}$
      \EndIf
      \EndWhile
      \State
      \State \LeftComment ペア依存度の更新
      \State $S\gets S\cup\mathrm{Affected}$
      \State $\mathrm{Affected}\gets\varnothing$
      \State \LeftComment 各要素の第二要素をキーとする順位キュー
      \State $R\gets((x,d'_{xz})\vert x\in S)$
      \While{$\lvert R\rvert>0$}
      \State $x,\_\gets\mathrm{popmax}(R)$
      \State $\delta'_z(x)\gets 0$
      \If{$x=z$}
      \State \textbf{continue}
      \EndIf
      \ForAll{$y\in\mathcal{N}_G(x)$}
      \If{$d'_{yz}=l_{yx}+d'_{xz}$}
      \State $\delta'_z(x)\gets\delta'_z(x)$
      $+\frac{\sigma'_{xz}}{\sigma'_{yz}}(1+\delta'_z(y)$
      \ElsIf{$d_{zx}=l_{xy}+d_{yz}$}
      \State $\mathrm{updatekey}(R, y, d'_{yz})$
      \EndIf
      \EndFor
      \EndWhile
      \EndProcedure
    \end{algorithmic}
  \end{multicols}
\end{algorithm}
